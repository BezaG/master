<!DOCTYPE html>
<!-- saved from url=(0093)http://blog.8thcolor.com/en/2011/08/nested-resources-with-independent-views-in-ruby-on-rails/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Nested resources with independent views in Ruby on Rails</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="PullReview: Automated Code Reviews for your GitHub Ruby projects. Code, push and get feedback about your last changes and branches. PullReview helps you to improve and keep your code clean, review after review.">
  <link rel="canonical" href="./Nested resources with independent views in Ruby on Rails_files/Nested resources with independent views in Ruby on Rails.html">

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="http://blog.8thcolor.com/css/syntax.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="http://blog.8thcolor.com/css/main.css">

  <link rel="icon" type="image/ico" href="http://www.pullreview.com/assets/favicon.ico">
  <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<script async="" src="./Nested resources with independent views in Ruby on Rails_files/analytics.js"></script><script type="text/javascript" async="" src="./Nested resources with independent views in Ruby on Rails_files/embed.js"></script></head>

<body class="">

  <div id="navbar">
    <div class="site">
      <a id="logo" href="https://www.pullreview.com/?utm_source=blog.8thcolor.com&utm_medium=banner&utm_campaign=blog">
        <img src="./Nested resources with independent views in Ruby on Rails_files/logo.png" alt="PullReview">
      </a>
      <span class="tagline">Automated Code Review for Ruby.</span>
      <div class="header">
        <ul>
          <li><a class="extra" href="http://blog.8thcolor.com/">Blog</a></li>
          <li><a class="extra" href="https://www.pullreview.com/site/hire_us?utm_source=blog.8thcolor.com&utm_medium=banner&utm_campaign=blog">Hire Us</a></li>
          <li><a class="extra" href="https://www.pullreview.com/?utm_source=blog.8thcolor.com&utm_medium=banner&utm_campaign=blog">PullReview</a></li>
          <li><a class="extra" href="https://www.pullreview.com/site/contact"><i class="icon-envelope-alt"></i></a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="site page-content">
  <div class="post-page">
  <header class="post-header">
    <a href="http://blog.8thcolor.com/" title="Back to posts list"><i class="icon-reply"></i> Back to posts list</a>

    <h1>Nested resources with independent views in Ruby on Rails</h1>
    <div class="meta"><i class="icon-calendar"></i>&nbsp;&nbsp;30 Aug 2011
     •
    	
    		<a href="http://about.me/toch">Christophe</a>
    	
    	
    </div>
  </header>

  <article class="post post-content">
  <h2>Introduction</h2>
<p>In <a title="Representational State Transfer" href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST-style architecture</a> , a <a title="Explain REST to my wife" href="http://tomayko.com/writings/rest-to-my-wife"><em>resource</em></a> is simply a source of information, the one you want to expose. The resource is referenced thanks to a global identifier such as an <a title="Uniform Resource Identifier" href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">URI</a>. When you deal with information structure such as composition, you'll use nested resources. The reference of the embedded resource is then built over the reference of the composite resource.</p>
<p>Ruby on Rails allows you to set up nested resources. For instance in the <a title="Getting started guide" href="http://guides.rubyonrails.org/getting_started.html">"Getting started" guide</a> where you build a very simple blog, Post and Comment are nested resources. Indeed, it is impossible to consider a lone comment without any post. A Comment <em>belongs&nbsp;to a Post</em>. Resources being referenced by URIs, the setup of nested resources in RoR is done through routing as following:</p>
<pre class="brush: rails; gutter: false">resources :posts do
 resources :comments
end</pre>
<p>But in the <a title="Getting Started guide" href="http://guides.rubyonrails.org/getting_started.html">example of the guide</a>, a Comment hasn't got its own view. A Comment is managed through the views of its Post. It's totaly suited to a blog, but in another case, maybe you would like to program nested resources with independant views, i.e. each resource has their views. This is the goal of this tutorial. I start from the same blog example, but this time I'll generate scaffolds for both models, Post and Comment.</p>
<h2>Same first steps: Post model</h2>
<p>First, create the blog application:</p>
<pre class="brush: bash; gutter: false">rails new blog
cd blog</pre>
<p>Generate a scaffolded Post resource:</p>
<pre class="brush: bash; gutter: false">rails generate scaffold Post name:string title:string content:text</pre>
<p>Add some validation to it (app/models/post.rb):</p>
<pre class="brush: rails; gutter: false">class Post &lt; ActiveRecord::Base
 validates :name,&nbsp; :presence =&gt; true
 validates :title, :presence =&gt; true, :length =&gt; { :minimum =&gt; 5 }
end</pre>
<p>Until now, it's totally the same than in the <a title="Getting Started guide" href="http://guides.rubyonrails.org/getting_started.html">guide</a>. The next step starts the fork!</p>
<h2>Fork: Comment Model</h2>
<p>Generate a scaffolded Comment resource:</p>
<pre class="brush: bash; gutter: false">rails generate scaffold Comment commenter:string body:text post:references</pre>
<p>Edit the app/models/post.rb file to add the other side of the association:</p>
<pre class="brush: rails; gutter: false">class Post &lt; ActiveRecord::Base
  validates :name,  :presence =&gt; true
  validates :title, :presence =&gt; true, :length =&gt; { :minimum =&gt; 5 }

  has_many :comments
end</pre>
<p>Setup nested resources (config/routes.rb):</p>
<pre class="brush: rails; gutter: false">resources :posts do
  resources :comments
end</pre>
<p>Add some validations to the Comment resource (app/models/comment.rb):</p>
<pre class="brush: rails; gutter: false">class Comment &lt; ActiveRecord::Base
  validates :commenter, :presence =&gt; true
  validates :body, :presence =&gt; true

  belongs_to :post
end</pre>
<h3>Comment controller</h3>
<p>Edit the Comment controller app/controllers/comments_controller.rb:</p>
<pre class="brush: rails; gutter: false">class CommentsController &lt; ApplicationController
  # GET /posts/:post_id/comments
  # GET /posts/:post_id/comments.xml
  def index
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you get all the comments of this post
    @comments = post.comments

    respond_to do |format|
      format.html # index.html.erb
      format.xml  { render :xml =&gt; @comments }
    end
  end

  # GET /posts/:post_id/comments/:id
  # GET /comments/:id.xml
  def show
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you retrieve the comment thanks to params[:id]
    @comment = post.comments.find(params[:id])

    respond_to do |format|
      format.html # show.html.erb
      format.xml  { render :xml =&gt; @comment }
    end
  end

  # GET /posts/:post_id/comments/new
  # GET /posts/:post_id/comments/new.xml
  def new
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you build a new one
    @comment = post.comments.build

    respond_to do |format|
      format.html # new.html.erb
      format.xml  { render :xml =&gt; @comment }
    end
  end

  # GET /posts/:post_id/comments/:id/edit
  def edit
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you retrieve the comment thanks to params[:id]
    @comment = post.comments.find(params[:id])
  end

  # POST /posts/:post_id/comments
  # POST /posts/:post_id/comments.xml
  def create
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you create the comment with arguments in params[:comment]
    @comment = post.comments.create(params[:comment])

    respond_to do |format|
      if @comment.save
        #1st argument of redirect_to is an array, in order to build the correct route to the nested resource comment
        format.html { redirect_to([@comment.post, @comment], :notice =&gt; 'Comment was successfully created.') }
        #the key :location is associated to an array in order to build the correct route to the nested resource comment
        format.xml  { render :xml =&gt; @comment, :status =&gt; :created, :location =&gt; [@comment.post, @comment] }
      else
        format.html { render :action =&gt; "new" }
        format.xml  { render :xml =&gt; @comment.errors, :status =&gt; :unprocessable_entity }
      end
    end
  end

  # PUT /posts/:post_id/comments/:id
  # PUT /posts/:post_id/comments/:id.xml
  def update
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you retrieve the comment thanks to params[:id]
    @comment = post.comments.find(params[:id])

    respond_to do |format|
      if @comment.update_attributes(params[:comment])
        #1st argument of redirect_to is an array, in order to build the correct route to the nested resource comment
        format.html { redirect_to([@comment.post, @comment], :notice =&gt; 'Comment was successfully updated.') }
        format.xml  { head :ok }
      else
        format.html { render :action =&gt; "edit" }
        format.xml  { render :xml =&gt; @comment.errors, :status =&gt; :unprocessable_entity }
      end
    end
  end

  # DELETE /posts/:post_id/comments/1
  # DELETE /posts/:post_id/comments/1.xml
  def destroy
    #1st you retrieve the post thanks to params[:post_id]
    post = Post.find(params[:post_id])
    #2nd you retrieve the comment thanks to params[:id]
    @comment = post.comments.find(params[:id])
    @comment.destroy

    respond_to do |format|
      #1st argument reference the path /posts/:post_id/comments/
      format.html { redirect_to(post_comments_url) }
      format.xml  { head :ok }
    end
  end
end</pre>
<p>The important changes are the following:</p>
<ul>
<li>Retrieve a Comment
<pre class="brush: rails; gutter: false">    post = Post.find(params[:post_id])
    @comment = post.comments.find(params[:id])</pre>
</li>
<li>Retrieve all Comments
<pre class="brush: rails; gutter: false">    post = Post.find(params[:post_id])
    @comments = post.comments</pre>
</li>
<li>Building of a new Comment
<pre class="brush: rails; gutter: false">    post = Post.find(params[:post_id])
    @comment = post.comments.build</pre>
</li>
<li>Creation of a new Comment
<pre class="brush: rails; gutter: false">    post = Post.find(params[:post_id])
    @comment = post.comments.create(params[:comment])</pre>
</li>
<li>Redirection to the Comment resource
<pre class="brush: rails; gutter: false">    redirect_to([@comment.post, @comment], :notice =&gt; 'Comment was successfully created.')</pre>
</li>
<li>Redirection to the list of Comments
<pre class="brush: rails; gutter: false">    redirect_to(post_comments_url)</pre>
</li>
</ul>
<h2>Comment Views</h2>
<p>Edit the views app/views/comments/:</p>
<ul>
<li>_form.html.erb: remove the :post member
<pre class="brush: html; gutter: false">&lt;%= form_for([@comment.post, @comment]) do |f| %&gt;
  &lt;% if @comment.errors.any? %&gt;
    &lt;div id="error_explanation"&gt;
      &lt;h2&gt;&lt;%= pluralize(@comment.errors.count, "error") %&gt; prohibited this comment from being saved:&lt;/h2&gt;

      &lt;ul&gt;
      &lt;% @comment.errors.full_messages.each do |msg| %&gt;
        &lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;
      &lt;% end %&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;% end %&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :commenter %&gt;&lt;br /&gt;
    &lt;%= f.text_field :commenter %&gt;
  &lt;/div&gt;
  &lt;div class="field"&gt;
    &lt;%= f.label :body %&gt;&lt;br /&gt;
    &lt;%= f.text_area :body %&gt;
  &lt;/div&gt;
  &lt;div class="actions"&gt;
    &lt;%= f.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;</pre>
</li>
<li>edit.html.erb: update link
<pre class="brush: html; gutter: false">&lt;h1&gt;Editing comment&lt;/h1&gt;

&lt;%= render 'form' %&gt;

&lt;!-- /posts/:post_id/comments/:id --&gt;
&lt;%= link_to 'Show', [@comment.post, @comment] %&gt; |
&lt;!-- /posts/:post_id/comments/ --&gt;
&lt;%= link_to 'Back', post_comments_path(@comment.post) %&gt;</pre>
</li>
<li>index.html.erb: remove :post member and update link
<pre class="brush: html; gutter: false">&lt;h1&gt;Listing comments&lt;/h1&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Commenter&lt;/th&gt;
    &lt;th&gt;Body&lt;/th&gt;
    &lt;th&gt;Post&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
  &lt;/tr&gt;

&lt;% @comments.each do |comment| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= comment.commenter %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= comment.body %&gt;&lt;/td&gt;

    &lt;!-- /posts/:post_id/comments/:id --&gt;
    &lt;td&gt;&lt;%= link_to 'Show', [comment.post, comment] %&gt;&lt;/td&gt;
    &lt;!-- /posts/:post_id/comments/:id/edit --&gt;
    &lt;td&gt;&lt;%= link_to 'Edit', edit_post_comment_path(comment.post, comment)%&gt;&lt;/td&gt;
    &lt;!-- /posts/:post_id/comments/:id --&gt;
    &lt;td&gt;&lt;%= link_to 'Destroy', [comment.post, comment], :confirm =&gt; 'Are you sure?', :method =&gt; :delete %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

&lt;br /&gt;

&lt;%= link_to 'New Comment', new_post_comment_path %&gt; &lt;!-- /posts/:post_id/comments/new --&gt;</pre>
</li>
<li>new.html.erb: update link
<pre class="brush: html; gutter: false">&lt;h1&gt;New comment&lt;/h1&gt;

&lt;%= render 'form' %&gt;

&lt;!-- /posts/:post_id/comments/ --&gt;
&lt;%= link_to 'Back', post_comments_path(@comment.post)%&gt;</pre>
</li>
<li>show.html.erb: remove :post member and update link
<pre class="brush: html; gutter: false">&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;p&gt;
  &lt;b&gt;Commenter:&lt;/b&gt;
  &lt;%= @comment.commenter %&gt;
&lt;/p&gt;

&lt;p&gt;
  &lt;b&gt;Body:&lt;/b&gt;
  &lt;%= @comment.body %&gt;
&lt;/p&gt;

&lt;!-- /posts/:post_id/comments/:id/edit --&gt;
&lt;%= link_to 'Edit', edit_post_comment_path(@comment.post, @comment) %&gt; |
&lt;!-- /posts/:post_id/comments/ --&gt;
&lt;%= link_to 'Back', post_comments_path(@comment.post) %&gt;</pre>
</li>
</ul>
<p>And finally, add a link to the show view of post app/views/posts/show.html.erb:</p>
<pre class="brush: html; gutter: false">&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;p&gt;
  &lt;b&gt;Name:&lt;/b&gt;
  &lt;%= @post.name %&gt;
&lt;/p&gt;

&lt;p&gt;
  &lt;b&gt;Title:&lt;/b&gt;
  &lt;%= @post.title %&gt;
&lt;/p&gt;

&lt;p&gt;
  &lt;b&gt;Content:&lt;/b&gt;
  &lt;%= @post.content %&gt;
&lt;/p&gt;

&lt;!-- /posts/:post_id/comments/ --&gt;
&lt;%= link_to 'Comments', post_comments_path(@post) %&gt; |
&lt;%= link_to 'Edit', edit_post_path(@post) %&gt; |
&lt;%= link_to 'Back', posts_path %&gt;</pre>
<p>As summary, the following table contains the paths used for the Comment resource:<br>
[table id=1 /]</p>
<h2>Final commands</h2>
<p>Check the routes:</p>
<pre class="brush: bash; gutter: false">rake routes
    post_comments GET    /posts/:post_id/comments(.:format)          {:controller=&gt;"comments", :action=&gt;"index"}
                  POST   /posts/:post_id/comments(.:format)          {:controller=&gt;"comments", :action=&gt;"create"}
 new_post_comment GET    /posts/:post_id/comments/new(.:format)      {:controller=&gt;"comments", :action=&gt;"new"}
edit_post_comment GET    /posts/:post_id/comments/:id/edit(.:format) {:controller=&gt;"comments", :action=&gt;"edit"}
     post_comment GET    /posts/:post_id/comments/:id(.:format)      {:controller=&gt;"comments", :action=&gt;"show"}
                  PUT    /posts/:post_id/comments/:id(.:format)      {:controller=&gt;"comments", :action=&gt;"update"}
                  DELETE /posts/:post_id/comments/:id(.:format)      {:controller=&gt;"comments", :action=&gt;"destroy"}
            posts GET    /posts(.:format)                            {:controller=&gt;"posts", :action=&gt;"index"}
                  POST   /posts(.:format)                            {:controller=&gt;"posts", :action=&gt;"create"}
         new_post GET    /posts/new(.:format)                        {:controller=&gt;"posts", :action=&gt;"new"}
        edit_post GET    /posts/:id/edit(.:format)                   {:controller=&gt;"posts", :action=&gt;"edit"}
             post GET    /posts/:id(.:format)                        {:controller=&gt;"posts", :action=&gt;"show"}
                  PUT    /posts/:id(.:format)                        {:controller=&gt;"posts", :action=&gt;"update"}
                  DELETE /posts/:id(.:format)                        {:controller=&gt;"posts", :action=&gt;"destroy"}</pre>
<p>Create and migrate the db:</p>
<pre class="brush: bash; gutter: false">rake db:create
rake db:migrate</pre>
<p>Run the server:</p>
<pre class="brush: bash; gutter: false">rails server</pre>
<p>Voilà!</p>

  </article>

  <div id="page-navigation">
  	<div class="clear">&nbsp;</div>
    <div class="left">
      
      <a href="http://blog.8thcolor.com/en/2011/08/why-we-and-others-still-need-jvms/" title="Previous Post: Why we (and others) still need JVMs"><i class="icon-double-angle-left"></i> Why we (and others) still need JVMs</a>
      
    </div>

    <div class="right">
      
        <a href="http://blog.8thcolor.com/en/2011/09/pitch-bootcamp-take-two/" title="next Post: Pitch Bootcamp, take two">Pitch Bootcamp, take two <i class="icon-double-angle-right"></i></a>
      
    </div>
  	<div class="clear">&nbsp;</div>
  </div>

    <form style="border: 1px dashed #000000; background-color:#eeeeee; padding: 25px;" action="http://8thcolor.us4.list-manage.com/subscribe/post?u=4c699a721dc16c7e14833175a&id=87e4812b3f" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
      <label for="mce-EMAIL"><strong>Struggling with code maintenance, fragile code, and bugs?</strong><br> Don't miss our next post and get more about best practices, code review, Ruby and Rails and PullReview directly in your inbox.</label><br><br>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required="">
      <input type="hidden" value="1" name="group[15437][1]" id="mce-group[15437]-15437-0" checked="">
      <input type="submit" value="Be notified of new posts and more!" name="subscribe" id="mc-embedded-subscribe" class="button cta">
    </form>
</div>

<div id="disqus_thread"><iframe id="dsq-2" data-disqus-uid="2" allowtransparency="true" frameborder="0" tabindex="0" title="Disqus" width="100%" src="./Nested resources with independent views in Ruby on Rails_files/saved_resource.html" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 2034px !important;" scrolling="no" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pullreview'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>



  </div>

  <div class="footer">
    <div class="site">
      <div class="copyright" <p="">Copyright&nbsp;©&nbsp;2014&nbsp;8th&nbsp;Color
          <br>
          Made in Brussels with pride <img src="./Nested resources with independent views in Ruby on Rails_files/iris.png" alt="Made in Brussels">
        <p></p>
      </div>
      <div class="footer-menu">
        <ul>
          <li><a class="extra" href="http://blog.8thcolor.com/">Blog</a></li>
          <li><a class="extra" href="http://www.pullreview.com/">Pullreview</a></li>
          <li><a class="extra" href="https://www.pullreview.com/site/contact"><i class="icon-envelope-alt"></i></a></li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-23242310-1', '8thcolor.com');
    ga('send', 'pageview');
  </script>


</body></html>